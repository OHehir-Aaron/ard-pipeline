Atmospherics
============

Specifically dealing with evaluating the radiative transfer for a defined set of spectra. The *gaip* package utilises `MODTRAN <http://modtran.spectral.com/>`_ for evalutating the radiative transfer.

The default number of points to evaluate the radiative transfer at is 9 for *nbar*, & 25 for *sbt*. If the *standard* model is chosen, then 25 points will be evaluated for both *nbar* and *sbt*. This is to make the workflow simpler and the output directories can be shared by both models, and share the same dependencies. The resulting *lambertian*, *nbar* and *nbart* datasets maybe slightly more accurate when using 25 points than 9 points.

Currently, the number of points are defined to cover the extents of an entire *scene*, or *granule* if the scene is *tiled*. For example a Sentinel-2a scene containing 15 granules, will subsequently have 15 * n points to evaluate the radiative transfer.

For the *nbar* model, the labels used for each radiative transfer calculation are:

    * albedo-0
    * albedo-1
    * albedo-t

For the *sbt* model, the label used for radiative transfer calculation is:

    * albedo-th

The coefficients for the *nbar* model are:

    * dir:

      * Direct irradiance at the surface

    * dif:

      * Diffuse irradiance at the surface

    * ts:

      * Direct transmittance in the solar direction

    * fv:

      * Direct fraction in the view direction; where :math:`fv = tv / (tv + tdv)`

        * tv:

          * Direct transmittance in the view direction

        * tdv:

          * Diffuse transmittance in the view direction

    * fs:

      * Direct fraction in the solar direction; where :math:`fs = ts / (ts + tds)`

        * ts:

          * Direct transmittance in the solar direction

        * tds:

          * Diffuse transmittance in the solar direction

    * b:

      * Path radiance due to atmospheric scattering

    * s:

      * Atmospheric albedo

    * a:

      * :math:`a = (dir + dif) / pi * (tv + tdv)`


The coefficients for the *sbt* model are:

    * path-up
    * path-down
    * transmittance-up
    * transmittance-down

For scenes that are *tiled* such as Sentinel-2a, the ancillary data used for input into the radiative transfer calculation, are averaged. This is to get around higher resolution datasets, as well as the low resolution ancillary.

For the *sbt* model, ancillary data is gathered at each point. This is different to the *nbar* model which (depending on the ancillary) is gathered at a single location, such as the scene centre, and used for input into each point location for the radiative transfer calculations.


Radiative transfer outputs (MODTRAN)
------------------------------------

The outputs from MODTRAN, when run via *gaip*, are converted from raw binary FORTRAN records into tables, for each point, for each albedo id (0, 1, t, th). The table names for the nbar model are:

* /altitudes
* /channel
* /flux
* /solar-irradiance

And the table names for the sbt model are:

* /upward-radiation-channel
* /downward-radiation-channel


NBAR Flux Tables
~~~~~~~~~~~~~~~~

Albedo id's 0, 1 & t
^^^^^^^^^^^^^^^^^^^^

**Note**; This represents the table structure only, the values might be different between Alebedo id's.

The first 10 rows of data are:

+------------+-------+----------------+------------------+--------------+
| wavelength | level | upward_diffuse | downward_diffuse | direct_solar |
+============+=======+================+==================+==============+
| 350        | 0     | 5.826921e-12   | 0.000026         | 0.000047     |
+------------+-------+----------------+------------------+--------------+
| 350        | 1     | 3.527054e-06   | 0.000026         | 0.000052     |
+------------+-------+----------------+------------------+--------------+
| 350        | 2     | 6.470059e-06   | 0.000025         | 0.000055     |
+------------+-------+----------------+------------------+--------------+
| 350        | 3     | 8.992295e-06   | 0.000024         | 0.000059     |
+------------+-------+----------------+------------------+--------------+
| 350        | 4     | 1.120117e-05   | 0.000022         | 0.000063     |
+------------+-------+----------------+------------------+--------------+
| 350        | 5     | 1.317290e-05   | 0.000021         | 0.000066     |
+------------+-------+----------------+------------------+--------------+
| 350        | 6     | 1.490633e-05   | 0.000019         | 0.000070     |
+------------+-------+----------------+------------------+--------------+
| 350        | 7     | 1.639941e-05   | 0.000017         | 0.000074     |
+------------+-------+----------------+------------------+--------------+
| 350        | 8     | 1.767662e-05   | 0.000015         | 0.000077     |
+------------+-------+----------------+------------------+--------------+
| 350        | 9     | 1.876851e-05   | 0.000013         | 0.000079     |
+------------+-------+----------------+------------------+--------------+


NBAR Solar Irradiance Tables
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The solar irradiance tables output by MODTRAN are stored by *gaip* using the following structures:

Albedo id's 0 & 1
^^^^^^^^^^^^^^^^^

**Note**; This represents the table structure only, the values might be different between Alebedo id's.

+--------+--------------+----------+------------+
| index  | diffuse      | direct   | direct_top |
+========+==============+==========+============+
| BAND 1 | 3.538757e-05 | 0.000041 | 0.000082   |
+--------+--------------+----------+------------+
| BAND 2 | 3.132190e-05 | 0.000052 | 0.000089   |
+--------+--------------+----------+------------+
| BAND 3 | 1.877508e-05 | 0.000055 | 0.000083   |
+--------+--------------+----------+------------+
| BAND 4 | 1.109452e-05 | 0.000053 | 0.000069   |
+--------+--------------+----------+------------+
| BAND 5 | 3.657224e-06 | 0.000038 | 0.000042   |
+--------+--------------+----------+------------+
| BAND 6 | 1.867395e-07 | 0.000010 | 0.000011   |
+--------+--------------+----------+------------+
| BAND 7 | 2.551867e-08 | 0.000003 | 0.000004   |
+--------+--------------+----------+------------+
| BAND 8 | 1.633472e-05 | 0.000054 | 0.000078   |
+--------+--------------+----------+------------+

Albedo id 't'
^^^^^^^^^^^^^

+--------+--------------+----------+-------------+------------+---------------+
| index  | diffuse      | direct   | diffuse_top | direct_top | transmittance |
+========+==============+==========+=============+============+===============+
| BAND 1 | 2.709969e-05 | 0.000129 | 0.0         | 0.000178   | 0.879114      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 2 | 2.393534e-05 | 0.000150 | 0.0         | 0.000193   | 0.903089      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 3 | 1.502591e-05 | 0.000148 | 0.0         | 0.000179   | 0.912310      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 4 | 8.961730e-06 | 0.000133 | 0.0         | 0.000150   | 0.943393      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 5 | 2.975956e-06 | 0.000087 | 0.0         | 0.000091   | 0.984325      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 6 | 1.699783e-07 | 0.000022 | 0.0         | 0.000023   | 0.971214      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 7 | 2.453214e-08 | 0.000007 | 0.0         | 0.000008   | 0.946506      |
+--------+--------------+----------+-------------+------------+---------------+
| BAND 8 | 1.305778e-05 | 0.000142 | 0.0         | 0.000168   | 0.921357      |
+--------+--------------+----------+-------------+------------+---------------+

SBT Upward and Downward Radiation Tables
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Upward radiation channel
^^^^^^^^^^^^^^^^^^^^^^^^

+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| band_id | 0           | 1 | 2        | 3            | 4        | 5        | 6       | 7        | 8      | 9       | 10       | 11  | 12  | 13  | 14       | 15  |
+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| BAND 10 | 10903.61133 | 1 | 0.000002 | 1.783579e-07 | 217.3092 | 0.000103 | 48.5184 | 576.0195 | 8950.0 | 14050.0 | 0.000103 | 0.0 | 0.0 | 0.0 | 0.768765 | 1.0 |
+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| BAND 11 | 12002.99512 | 2 | 0.000004 | 2.507863e-07 | 228.1817 | 0.000248 | 68.7634 | 988.0800 | 8950.0 | 14050.0 | 0.000248 | 0.0 | 0.0 | 0.0 | 0.652540 | 1.0 |
+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+


Downward radiation channel
^^^^^^^^^^^^^^^^^^^^^^^^^^

+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| band_id | 0           | 1 | 2        | 3            | 4        | 5        | 6       | 7        | 8      | 9       | 10       | 11  | 12  | 13  | 14       | 15  |
+=========+=============+===+==========+==============+==========+==========+=========+==========+========+=========+==========+=====+=====+=====+==========+=====+
| BAND 10 | 10903.61133 | 1 | 0.000003 | 2.890165e-07 | 236.0131 | 0.000166 | 48.5184 | 576.0195 | 8950.0 | 14050.0 | 0.000166 | 0.0 | 0.0 | 0.0 | 0.643813 | 1.0 |
+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+
| BAND 11 | 12002.99512 | 2 | 0.000006 | 3.864675e-07 | 248.4874 | 0.000382 | 68.7634 | 988.0800 | 8950.0 | 14050.0 | 0.000382 | 0.0 | 0.0 | 0.0 | 0.505662 | 1.0 |
+---------+-------------+---+----------+--------------+----------+----------+---------+----------+--------+---------+----------+-----+-----+-----+----------+-----+


Coefficients Tables
-------------------

The table dataset names for the NBAR and SBT workflow models are:

* /coefficients/nbar-coefficients
* /coefficients/sbt-coefficients

if the scene is not composed of multiple tiles/granules in which case the *coefficiencts* Group is at the root layer of the *gaip.singlefile_workflow* or the *gaip.multifile_workflow*, otherwise the *granule name* eg *S2A_USER_MSI_L2A_TL_SGS__20160120T053143_A003016_T55KBQ_N02.01* would precede the *coefficients* Group in the *gaip.singlefile_workflow* like such:

* /S2A_USER_MSI_L2A_TL_SGS__20160120T053143_A003016_T55KBQ_N02.01/coefficients/nbar-coefficients
* /S2A_USER_MSI_L2A_TL_SGS__20160120T053143_A003016_T55KBQ_N02.01/coefficients/sbt-coefficients


NBAR Coefficients table
~~~~~~~~~~~~~~~~~~~~~~~

The first 10 rows of data for the NBAR coefficients are:

+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| index | band_id | point | fs       | fv       | a          | b         | s        | dir        | dif        | ds       |
+=======+=========+=======+==========+==========+============+===========+==========+============+============+==========+
| 0     | BAND 1  | 0     | 0.660515 | 0.826875 | 175.344465 | 33.739320 | 0.183848 | 413.885127 | 212.724257 | 0.503456 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 1     | BAND 2  | 0     | 0.729417 | 0.862580 | 205.229852 | 26.913760 | 0.143936 | 520.757751 | 193.179448 | 0.584813 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 2     | BAND 3  | 0     | 0.818751 | 0.907906 | 195.469390 | 13.203970 | 0.088989 | 551.109556 | 122.000483 | 0.667437 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 3     | BAND 4  | 0     | 0.876648 | 0.936849 | 182.752374 | 6.500401  | 0.055667 | 533.513087 | 75.070204  | 0.768183 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 4     | BAND 5  | 0     | 0.936031 | 0.966883 | 126.957265 | 1.530495  | 0.025615 | 379.279264 | 25.920334  | 0.899831 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 5     | BAND 6  | 0     | 0.985765 | 0.992478 | 31.353651  | 0.047970  | 0.004160 | 99.976143  | 1.443731   | 0.930715 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 6     | BAND 7  | 0     | 0.993826 | 0.996726 | 9.909080   | 0.005911  | 0.001582 | 32.686643  | 0.203062   | 0.894236 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 7     | BAND 8  | 0     | 0.835007 | 0.915808 | 189.914477 | 11.188690 | 0.080254 | 540.716753 | 106.843105 | 0.695733 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 8     | BAND 1  | 1     | 0.665695 | 0.828555 | 179.657456 | 32.707770 | 0.183871 | 426.796574 | 214.333164 | 0.509699 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+
| 9     | BAND 2  | 1     | 0.733614 | 0.863914 | 210.086902 | 26.037650 | 0.143957 | 535.543889 | 194.464016 | 0.590456 |
+-------+---------+-------+----------+----------+------------+-----------+----------+------------+------------+----------+


SBT Coefficients table
~~~~~~~~~~~~~~~~~~~~~~

The first 10 rows of data for the SBT coefficients are:

+-------+---------+-------+----------+-----------+------------------+--------------------+
| index | band_id | point | path-up  | path-down | transmittance-up | transmittance-down |
+=======+=========+=======+==========+===========+==================+====================+
| 0     | BAND 10 | 0     | 1.636909 | 2.668010  | 0.781590         | 0.663209           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 1     | BAND 11 | 0     | 2.332763 | 3.627675  | 0.668446         | 0.527527           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 2     | BAND 10 | 1     | 1.654217 | 2.714787  | 0.782114         | 0.661033           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 3     | BAND 11 | 1     | 2.355024 | 3.677702  | 0.669172         | 0.525138           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 4     | BAND 10 | 2     | 1.637271 | 2.692097  | 0.786132         | 0.665885           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 5     | BAND 11 | 2     | 2.336454 | 3.650324  | 0.674382         | 0.530870           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 6     | BAND 10 | 3     | 1.646038 | 2.698222  | 0.786254         | 0.666608           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 7     | BAND 11 | 3     | 2.347273 | 3.654962  | 0.674669         | 0.531837           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 8     | BAND 10 | 4     | 1.723207 | 2.798703  | 0.778608         | 0.657158           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
| 9     | BAND 11 | 4     | 2.438746 | 3.761915  | 0.665208         | 0.521180           |
+-------+---------+-------+----------+-----------+------------------+--------------------+
